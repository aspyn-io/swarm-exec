# GitHub Copilot Instructions

## Project Overview

This repository contains `swarm-exec`, a GitHub Action for executing commands in Docker Swarm service containers with health checking capabilities. The project uses Bash scripting with comprehensive testing and linting.

## Development Requirements

### 🧪 Testing with BATS

**ALL code changes must pass BATS unit tests:**

- Run tests before submitting: `bats tests/unit.bats`
- Tests are located in `tests/unit.bats`
- Tests use BATS (Bash Automated Testing System) version 1.5.0+
- Tests mock Docker commands using stub functions in `$TMPDIR`
- When modifying functions, ensure corresponding tests are updated
- New functionality requires new test cases

**Test Guidelines:**

- Tests must account for log output from functions (use `tail -n1` to get return values)
- Use test-specific temporary files (not global `/tmp` files)
- Mock all external dependencies (docker, ssh, curl, wget)
- Test both success and failure scenarios
- Include timeout and edge case testing

### 🔍 Linting with ShellCheck

**ALL shell scripts must pass ShellCheck linting:**

- Run linting before submitting: `shellcheck -x scripts/swarm-exec.sh`
- Fix ALL ShellCheck warnings and errors
- Follow ShellCheck best practices (e.g., SC2155: declare and assign separately)
- Use proper quoting and variable expansion
- Handle error conditions appropriately

### 🏗️ CI/CD Pipeline

The CI pipeline runs three jobs that **MUST** all pass:

1. **Lint Job**: Runs ShellCheck on all shell scripts
2. **Unit Test Job**: Runs BATS unit tests
3. **Integration Test Job**: Tests with real Docker Swarm environment

### 📝 Code Standards

**Shell Script Standards:**

- Use `set -euo pipefail` for strict error handling
- Declare variables with `local` in functions
- Use `"${variable:-default}"` for default values
- Quote all variable expansions: `"$variable"`
- Use `command -v` to check for command availability
- Handle both local and remote execution paths

**Function Design:**

- Functions should have single responsibilities
- Use descriptive function and variable names
- Include error handling and timeouts
- Log important steps using the `log()` function
- Return meaningful exit codes

### 🛠️ VS Code Setup

This repository includes recommended extensions:

- `jetmartin.bats` - BATS language support
- `timonwong.shellcheck` - Real-time ShellCheck linting
- `foxundermoon.shell-format` - Shell script formatting

## Before Making Changes

1. **Understand the health checking logic**: The script supports Docker healthchecks, HTTP endpoint probes, and fallback to running state
2. **Review existing tests**: Understand how functions are tested and mocked
3. **Run tests locally**: Always test changes before committing
4. **Check linting**: Ensure ShellCheck passes without warnings

## When Adding New Features

1. **Write tests first**: Add test cases to `tests/unit.bats`
2. **Mock dependencies**: Create appropriate Docker/SSH stubs
3. **Test edge cases**: Include timeout, failure, and retry scenarios
4. **Update documentation**: Modify README.md if user-facing changes
5. **Verify CI**: Ensure all three CI jobs pass

## Common Patterns

**Error Handling:**

```bash
command_result="$(some_command 2>/dev/null || true)"
if [ -z "$command_result" ]; then
  echo "::error::Command failed"
  exit 1
fi
```

**Timeout Loops:**

```bash
start="$(date +%s)"
while :; do
  # ... check condition ...
  elapsed=$(( $(date +%s) - start ))
  [ "$elapsed" -ge "$TIMEOUT" ] && { echo "::error::Timeout"; return 1; }
  sleep "$INTERVAL"
done
```

**Variable Declaration (ShellCheck SC2155):**

```bash
# Good - declare and assign separately
local variable
variable="$(command_that_might_fail)"

# Avoid - masks return values
local variable="$(command_that_might_fail)"
```

Remember: **Quality over speed** - ensure tests pass and code is linted before submitting changes.
